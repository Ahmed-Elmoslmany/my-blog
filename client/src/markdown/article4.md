## كيف يحدث هجوم الـ DOS على الـ API او الموقع الخاص بك
ببساطة يمكن لأي شخص عمل هجوم  DOS على الـ API او الـ Server الخاص بك

- كيف يحدث هذا؟
= أبسط طريقة هي عمل Infiniti-loop على أي Endpoint يوفرها الـ API

مثال بسيط: يقوم الكود التالي بعمل 10 ألاف Call للـ API الخاص بي على Local  machine الخاصة بي 
```js
const url = "http://localhost:3000/api/v1/endpoint"
let i = 0;
const callAPI =  () => {
    fetch(url)
    i++
}
```

```js
while(i < 10000){
	 callAPI()
}
	
```

كانت 10 ألاف طلب Requests كفيلة لتعطيل الخدمة وإيقاف الـ Server، ببساطة لقد قمت بعمل Denial Of Service وأختصاره هو DoS


## إذاً ماذا حدث بالضبط؟
عندما نقوم بعمل Request او طلب على الـ Server يذهب الـ Server اتنفيذ الطلب ويرجع لنا بما طلبناه، ويمكن للـ Server تنفيذ عدة طلبات في وقت واحد ولكن لن عندما طلبنا أكثر من 10 ألاق طل لم يستطع الـ Server تنفيذ 10 الأف طلب في وقت قصير وتعطل الـ Server وتوقف عن العمل لذا أحتجت لعمل Restart له ليعمل مجدداً، وهذه الحالة متعلقة بالجهاز الخاص بي ولكن هناك خوادم Servers تستطيع تنفيذ طلبات أكثر من هذا الرقم 

مثال توضيحي: تخيل أنك تعمل في مطعم وتستطيع تنفيذ طلب واحد لأي زبون خلال دقيقتين، تخيل معي ماذا سيحدث في الحالات التالية:

- جاء إليك زبون ويريد طلب واحد فقط، بالطبع ستنفذ له طلبه وتسير الأمور بكل سلاسة
- جاء إليك زبونان في نفس الوقت ويريدان نفس الطلب، ستعاني بعض الشئ ولك ستسير الأمور بشكل جيد
-  جاء إليك 5 زبائن في نفس الوقت ويريدان نفس طلب، بالطبع ستعاني وربما تتأخر عليه في تنفيذ الطلب ولكن ستنتهي من الطلب في وقت ما 
- ماذا إذا جاءك 100 زبون في نفس الوقت ويريدون نفس الطلب، بالتأكيد أنك ستنهار وربما تُقدم إستقالتك😅، وهذا ما يحدث بالضبط للـ API او للـ Server او للموقع الخاص بناعندما تأتيه طلبات كثيرة في نفس الوقت


## ما الحل إذاً؟
لحسن الحظ هذه مشكلة شائعة ولهذا السبب لها حلول عدة ومنها شئ يُسمى Rate Limiting، ومعنى مفهوم الـ Rate limiting أنك تقوم بتحديد حد أقصى لعدد الـ Requests او الطلبات التي تأتيك من نفس الـ IP الخاص بمستخدم او جهاز معين على الأنترنت

مثال: نقوم بتخصيص 50 Request في الساعة لكل مستخدم او جهاز يريد تنفيذ Request بواسطة الـ API الخاص بنا، فإذا نفذ 50 Request خلال ساعة وأراد تنفيذ المزيد فسيتم حظره ولن يستطيع تنفيذ أي Request أخر خلال هذا الساعة

## لماذا نستخدام Rate Limiting 
- بإستخدام Rate Limiting نستطيع تجنب Brute Force Attack كما حدث في السابق بعمل Infiniti-loop على الـ API


## أستخدام Rate Limiting في Express NodeJs
توجد Package جاهزة يُمكننا أستخدامها، وكل ما علينا هو تنزيلها بواسطة السطر التالي:
```bash
npm install express-rate-limit
```

نقوم بإنشاء الـ Rate Limiting middleware الخاص بنا كالتالي:
```js
const express = require('express');
const rateLimiting = require('express-rate-limit'); // أستدعاء الـ rate limiting package

const app = express(); // إنشاء Express App
```

```js
// تعريف الـ Limiter middleware 
const limiter = rateLimiting({
  windowMs: 5 * 60 * 1000 // هنا نكتب الوقت المحدد بالملي ثانية سيكون الناتج هنا 5 دقائق 
  max: 50 // هنا نكتب الحد الأقصى من الطلبات المتاحة خلال 5 دقائق
  message: 'Oops! It seems you try to make many requests in small duration of time, please try again later.', // وهنا نكتب رسالة تظهر للمستخدم إذا تخطئ الحد الأقصى
});
```

```js
// ثم أخيرًانفعل ما بنيناه لجميع الطلبات التي تأتينا Requests
app.use(limiter);
```

~ هل لاحظت شيئًا في المثال السابق؟
لقد قمنا بتخصيص 50 Requests لكل مستخدم خلال 5 دقائق على الـ API كله، وهذا غير عملي في الحياة الواقعية فربما يكون لدينا API فيه أكثر من Endpoint وهناك Endpoint معينة تستخدم بكثرة، و Endpoint أخرى في نفس الـ API لا تستخدم كثيرًا، دعنا نوضح الأمر بالمثال التالي~

## Rate Limiting Customized لماذا نحتاج
أفترض ان لديك  API  وفيه إثنان Endpoints واحدة تجلب مقالة عشوائية من الـ Database والـ Endpoint الأخرى تقوم بتسجيل دخول المستخدم على الموقع الخاص بك.
إذاً في هذه الحالة هل تعتقد ان تخصيص 50 Request لكل IP كل 5 دقائق أمر جيد؟ بالطبع لا،  ربما يحتاج المستخدم لـ 50 Request كل 5 دقائق لجلب مقالة عشوائية من الـ Database ولكن لا يحتاج الى 50 Request ليقوم بتسجيل الدخول!


لماذا لا يحتاج المستخدم لأكثر من 50 Request لتسجيل الدخول؟
ببساطة لا أحد سيجرب 50 مرة لتسجيل الدخول على أي موقع، وسبب أخر ربما يكون هناك شخص يحاول تسجيل الدخول للموقع بإستخدام حسابك الشخصي

لذا إعطاء 50 محاولة لهذا الشخص ليجرب فيها تسجيل الدخول بإستخدام حسابك الشخصي هو أمر خطير! لانه ربما تصادف معه في أي مرة من هذه المرات كتابة الأميل والباسورد بشكل صحيح، لاحظ أننا هنا نفترض ان هذا الشخص شاهدك وانت تكتب الأميل والباسورد ولكن نسي بعض الحروف و نسي الترتيب الصحيح، في هذه الحالة ستكون 50 محاولة أمر خطير جداً

وهناك حالة أخرى ان شخص ما يعرف الأميل الخاص بك وفقط ينقصه الباسورد، وفيه هذه الحالة جد يجرب Brute Force Script ليخمن الباسورد الخاص بك و 50 محاولة لهذا الشخص ستكون فرصة رائعة

## مثال عن Rate Limiting Customized 
كما في السابق نقوم بتنزيل `express-rate-limit`   وننشئ الـ Limiter الخاص بنا:
```js
const express = require('express');
const rateLimiting = require('express-rate-limit');

const app = express();
```


```js
// هنا نُخصص 50 ريكويست كل 5 دقائق لجلب مقالة عشوائية
const randomArticleLimiter = rateLimiting({
  windowMs: 5 * 60 * 1000, 
  max: 50, 
  message: 'Oops! It seems you try to make many requests in small duration of time, please try again later.',
});
```

```js
// هنا نُخصص 5 محاولات للمستخدم لتسجيل الدخول كل 5 دقائق
const loginLimiter = rateLimiting({
  windowMs: 5 * 60 * 1000, 
  max: 5, 
  message: 'Oops! It seems you try to login into system many times in small duration of time, please try again later.',
});
``` 

```js
// هنا نقوم بتخصيص لكل Endpoint
app.use('/api/v1/article/randomarticle', randomArticleLimiter); 
app.use('/api/v1/auth/login', loginLimiter);
```

ملاحظة: الـ Rate Limiting يحتاج لمزيد من التفصيل حسب الحالة التي تعمل عليها لذا يُرجى قراءة المزيد في هذا الموضوع

## خاتمة مع الـ Distributed DoS 
كل ما سبق كان DoS عادي يحدث من جهاز واحد فقط ويمكنك حماية الـ API الخاص بك عن طريق Rate Limiting كما فعلنا سابقًا، ولكن يوجد طريقة أخرى يُمكن لشخص مُحترف تعطيل الـ API الخاص بك بإستخدامها وهي ما تسمى Distributed Denial of Service حيث يقوم هذا الشخص بإستخدام أجهزة متعددة ربما الألاف لتعطيل الـ Server الخاص بك عن طريق عمل Requests متعددة في نفس الموقت من أجهزة كثيرة جدا، وربما نتحدث عن هذا الأمر لاحقًا  إن شاء الله .. سلام 👋